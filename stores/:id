<style>
    .demo1{
float: left;
 margin-bottom:29px;
  height: 318px;
    width: 562px;
background-color: #FFFFFF ;
  border: 1px solid #b2aaab;

}

.page_banner {
    line-height:1;
    padding-top:30px;
}
.banner_1{
    margin-bottom:5px;
}
.banner_2{
    font-size:12px;
}
.froala-element img{
    cursor:default !important;
}
.marker {
    background: url("//kodekloud.s3.amazonaws.com/sites/54cfab316e6f6433ad020000/530d3a9b7bc13ce4a511089c23463f99/10dundas_pin.png") no-repeat;
    cursor: pointer;
    display: block;
    height: 75px;
    margin-top: 5px;
    outline: medium none;
    text-indent: -9999px;
    width: 50px;
}
@media (max-width: 767px) {
    #store_desc_container{
        display:none !important;
    }
    
    .right_column{
        display:block !important;
    }
    #mobile_desc{
        display: block !important;
        margin-top:20px;
        margin-bottom:20px;
    }
    .mobile_promo_divs{
        display:block !important;
    }
    .desktop_promo_divs{
        display:none !important;
    }
}
</style>
<script src="//kodekloud.s3.amazonaws.com/sites/5438407c6e6f64462d020000/92b82a88144a6207ab1a5e8e0f63d3d1/craftmap.js"></script>
<div id="loading_screen">
    <img alt="loading" src="//kodekloud.s3.amazonaws.com/sites/5447ebb66e6f641987020000/3604f5c26997bea3de504de139debcec/loading.gif"/>
</div>
<div id="store_title_container">
    <script id="store_title_template" type="x-tmpl-mustache">
        <ul class="breadcrumb">
            <li><a href="/home">Home</a> </li>
            <li><a href="/stores">Store Directory</a></li>
            <li class="active">{{name}}</li>
        </ul>
        <div class="page_banner">
                <p class="banner_1">{{name}} </p>
                
        </div>
    </script>
</div>
<div  id="main_content" style="display:none">
    <div class="inside_page_content">
        <div class="left_column">
        <img src= "//codecloud.cdn.speedyrails.net/sites/57f7e7fb6e6f640d538b0000/image/png/1448649677000/storesmap.png">
        <br><br>
            <!--<div class="store_map" id="store_map">-->
            
                <!--<script id="store_deatils_map_template" type="x-tmpl-mustache">
                    <div class="demo1">
                        <img alt="map" src="" class="imgMap" id="map_image" />                
                        <div class="marker" id='scroll_to_marker' data-coords="{{x_coordinate}}, {{y_coordinate}}"></div>   
                    </div>   
                </script> -->
            <!--</div>-->
            <div id="store_desc_container">
                <script id="store_desc_template" type="x-tmpl-mustache">
                    <p>{{description}}</p>
                </script>
            </div>
            <div class="desktop_promo_divs">
                <p class="list_section_header" style="display:none" id="promo_header" >Promotions</p>
                <div class="promo_list_div" id="promo_list_container">
                    <script id="promo_list_template" type="x-tmpl-mustache/text">
                        <div class="promo_inside_content">
                        <div class="promo_image_div">
                            <a href="{{alt_promo_image_url}}" rel="lightbox-gallery" title="{{name}}">
                                <img alt="promo image" class="promo_image" src="{{alt_promo_image_url}}" />
                            </a> 
                        </div>
                        <div class="promo_desc_box">
                            <a href="../promotions/{{slug}}"><p class="promo_header right_column_header">{{name}}</p></a>
                            <p class="directory_content promo_date">{{dates}}</p>
                            <p>{{description}}</p>
                            <a href="../promotions/{{slug}}" class="btn btn-primary pull-left">Read More</a> </div>
                        </div>
                    </div>
                    </script>
                </div>
                
                <p class="list_section_header" style="display:none" id="job_header" >Jobs</p>
                <div class="promo_list_div" id="job_list_container">
                    <script id="job_list_template" type="x-tmpl-mustache/text">
                        <div class="promo_inside_content">
                            <div class="promo_desc_box" style="width:100%">
                                <a href="../jobs/{{slug}}"><p class="promo_header right_column_header">{{name}}</p></a>
                                <p class="directory_content promo_date"><a href="/stores/{{store_detail_btn}}">{{store_name}}</a><br>{{job_type}}<a href="../jobs/{{slug}}" class="btn btn-primary pull-right" style="margin-top:-17px">Read More</a></p>
                            </div>
                        </div>
                    </script>
                </div>
            </div>
        </div>
        <div class="right_column">
            <div id="store_detail_container">
                <script id="store_detail_template" type="x-tmpl-mustache/text">
                    <img class="detail_logo" src="{{alt_store_front_url}}">
                    <p class="directory_content" id="mobile_desc" style="display:none">{{description}}</p>
                    <p class="right_column_header" id="phone_label">Phone</p>
                    <p class="directory_content">{{phone}}</p>
                    <br>
                    <p class="right_column_header" id="email_label">Email</p>
                    <p class="directory_content">{{email}}</p>
                </script>
            </div>
                            
            <p class="right_column_header" id="hours_title" style="display:none">Hours</p>
            <div id="store_hours_container">
                <script id="store_hours_template" type="x-tmpl-mustache/text">
                    <li class="directory_content" style="list-style:none">{{h}}</li>
                </script>
            </div>
            <br>
            <div id="store_detail_container2">
                <script id="store_detail_template2" type="x-tmpl-mustache/text">
                  <a style="display:none" id="store_website_link" href="//{{website}}" target="_blank" class="btn-primary center-block btn-lg">Visit Store Site</a> 
                </script>
            </div>
            
            <div class="mobile_promo_divs" style="display:none">
                <p class="list_section_header" style="display:none" id="mobile_promo_header" >Promotions</p>
                <div class="promo_list_div" id="mobile_promo_list_container">
                    <script id="mobile_promo_list_template" type="x-tmpl-mustache/text">
                        <div class="promo_inside_content">
                        <div class="promo_image_div">
                            <a href="{{alt_promo_image_url}}" rel="lightbox-gallery" title="{{name}}">
                                <img alt="promo image" class="promo_image" src="{{alt_promo_image_url}}" />
                            </a> 
                        </div>
                        <div class="promo_desc_box">
                            <a href="../promotions/{{slug}}"><p class="promo_header right_column_header">{{name}}</p></a>
                            <p class="directory_content promo_date">{{dates}}</p>
                            <p>{{description}}</p>
                            <a href="../promotions/{{slug}}" class="btn btn-primary pull-left">Read More</a> </div>
                        </div>
                    </div>
                    </script>
                </div>
                
                <p class="list_section_header" style="display:none" id="mobile_job_header" >Jobs</p>
                <div class="promo_list_div" id="mobile_job_list_container">
                    <script id="mobile_job_list_template" type="x-tmpl-mustache/text">
                       <div class="promo_inside_content">
                            <div class="promo_desc_box" style="width:100%">
                                <a href="../jobs/{{slug}}"><p class="promo_header right_column_header">{{name}}</p></a>
                                <p class="directory_content promo_date"><a href="/stores/{{store_detail_btn}}">{{store_name}}</a><br>{{job_type}}<a href="../jobs/{{slug}}" class="btn btn-primary pull-right" style="margin-top:-17px">Read More</a></p>
                            </div>
                        </div>
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>

<!--For more information please see //learnjs.io/blog/2013/11/30/snapsvg-resources/-->
<script src="//cdnjs.cloudflare.com/ajax/libs/snap.svg/0.3.0/snap.svg-min.js"></script>
<script src="//kodekloud.s3.amazonaws.com/sites/5422419e4a616d74d9030000/e1fb5e17ab727d248230fbcb51da868f/jquery.panzoom.min.js"></script>
 
<script>
    $(document).ready(function() {
        function renderPageData(){
            //renders the store list by referencing the template id and the html id
            //for where to place the rendered content. See mallmaverick.js for implementation
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            var store_details = getStoreDetailsBySlug(slug);
            if (store_details.store_hours.length > 0 ){
                $("#hours_title").show();
            } 
            store_details.x_coordinate = store_details.x_coordinate - 17;
            store_details.y_coordinate = store_details.y_coordinate - 75;
            // checkErrorPage(store_details);
            var store_promos = getPromotionsForIds(store_details.promotions);
            store_promos = store_promos.reverse();
            promo_array = []
            $.each( store_promos , function( key, val ){
                // today = new Date();
                // webDate = new Date(val.show_on_web_date);
                
                today = moment();
                webDate = moment(val.show_on_web_date);
                if (today >= webDate) {
                    promo_array.push(val)
                } 
            });
            store_promos = promo_array;
            var jobs = getJobsForIds(store_details.jobs);
            jobs = jobs.reverse();
            jobs_array = []
            $.each( jobs , function( key, val ){
                // today = new Date();
                // webDate = new Date(val.show_on_web_date);
                
                today = moment();
                webDate = moment(val.show_on_web_date);
                if (today >= webDate) {
                    jobs_array.push(val)
                } 
            });
            jobs = jobs_array;
            $('#loading_screen').hide();
            $('#main_content').fadeIn();
            // store_details.map_x_coordinate = store_details.x_coordinate - 19;
            // store_details.map_y_coordinate = store_details.y_coordinate - 58;
            renderTemplate("#store_title_container","#store_title_template", store_details, "store_details");
            renderTemplate("#store_desc_container", "#store_desc_template", store_details, "store_details");
            renderTemplate("#store_detail_container","#store_detail_template", store_details, "store_details");
            renderTemplate("#store_hours_container","#store_hours_template", store_details, "hours");
            renderTemplate("#store_detail_container2","#store_detail_template2", store_details, "store_details");
            renderTemplate("#promo_list_container","#promo_list_template", store_promos, "promotions");
            renderTemplate("#job_list_container","#job_list_template", jobs, "jobs");
            renderTemplate("#mobile_promo_list_container","#mobile_promo_list_template", store_promos, "promotions");
            renderTemplate("#mobile_job_list_container","#mobile_job_list_template", jobs, "jobs");
            renderStoreDetailsTemplate('#store_deatils_map_template','#store_map',store_details);
            var propertyDetails = getPropertyDetails();
            $("#map_image").attr("src", getPNGMapURL())
            $(function(){
                $('.demo1').craftmap({
                    image: {
                        width: propertyDetails.map_image_width,
                        height: propertyDetails.map_image_height,
                        name: 'imgMap'
                    },
                    map: {
                        position: 'center'
                    }
                });
                $("#anchor_id").click();
                $("#scroll_to_marker").click();
            });
            $.getScript("//cdn.jsdelivr.net/slimbox/2.0.5/js/slimbox2.js");
            $('head').append('<link rel="stylesheet" href="//cdn.jsdelivr.net/slimbox/2.0.5/css/slimbox2.css" type="text/css" media="screen" />');
        }
        
        function get_month (id){
            switch(id) {
                case 0:
                    month = "Jan"
                    break;
                case 1:
                    month = "Feb"
                    break;
                case 2:
                    month = "Mar"
                    break;
                case 3:
                    month = "Apr"
                    break;
                case 4:
                    month = "May"
                    break;
                case 5:
                    month = "June"
                    break;
                case 6:
                    month = "July"
                    break;
                case 7:
                    month = "Aug"
                    break;
                case 8:
                    month = "Sep"
                    break;
                case 9:
                    month = "Oct"
                    break;
                case 10:
                    month = "Nov"
                    break;
                case 11:
                    month = "Dec"
                    break;
            }
            return month;
        }
        loadMallData(renderPageData);
        
        function renderTemplate(container, template, collection, type){
            var item_list = [];
            var item_rendered = [];
            var template_html = $(template).html();
            Mustache.parse(template_html);   // optional, speeds up future uses
            if (type == "store_details"){
                item_list.push(collection)
                $.each( item_list , function( key, val ) {
                    if (val.phone){
                        $("#phone_label").show();
                    } else {
                        $("#phone_label").hide();
                    }
                    if (val.email){
                        $("#email_label").show();
                    } else {
                         $("#email_label").hide();
                    }
                    switch(val.z_coordinate) {
                        case 0: 
                            val.z_coordinate = "B2"
                            break;
                        case 1:
                            val.z_coordinate = "B1"
                            break;
                        case 2:
                            val.z_coordinate = "Level 1"
                            break;
                        case 3:
                            val.z_coordinate = "Level 2"
                            break;
                        case 4:
                            val.z_coordinate = "Level 3"
                            break;
                        case 5:
                            val.z_coordinate = "Level 4"
                            break;
                        case 6:
                            val.z_coordinate = "Level 5"
                            break;
                    }
                    if ((val.store_front_url).indexOf('missing.png') > -1){
                        val.alt_store_front_url = "//codecloud.cdn.speedyrails.net/sites/55a96a326e6f6453a2010000/76e41eb9cfb54adf1f88b2168014aefa/DO_default.jpg"
                    } else {
                        val.alt_store_front_url = getImageURL(val.store_front_url); 
                    }
                    // val.alt_store_front_url = getImageURL(val.store_front_url); 
                    val.hours = (getHoursForIds(val.store_hours))
                    var rendered = Mustache.render(template_html,val);
                    item_rendered.push(rendered);
                });
            } else if (type == "hours"){
                hours = getHoursForIds(collection.store_hours)
                $.each( hours , function( key, val ) {
                    switch(val.day_of_week) {
                        case 0:
                            val.day = "Sunday"
                            break;
                        case 1:
                            val.day = "Monday"
                            break;
                        case 2:
                            val.day = "Tuesday"
                            break;
                        case 3:
                            val.day = "Wednesday"
                            break;
                        case 4:
                            val.day = "Thursday"
                            break;
                        case 5:
                            val.day = "Friday"
                            break;
                        case 6:
                            val.day = "Saturday"
                            break;
                    }
                    if (val.open_time && val.close_time && (val.is_closed == false || val.is_closed == null)){
                        // var open_time = new Date (val.open_time)
                        // var close_time = new Date (val.close_time)
                        // val.open_time = convert_hour(open_time);
                        // val.close_time = convert_hour(close_time);    
                        // val.h = val.day+": "+val.open_time+ " - " + val.close_time;
                        
                        var open_time = moment(val.open_time).tz(getPropertyTimeZone());
                        var close_time = moment(val.close_time).tz(getPropertyTimeZone());
                        val.h = val.day + ": " + open_time.format("h:mm A") + " - " + close_time.format("h:mm A");
                    } else {
                        val.h = val.day + ": Closed"
                    }
                    var rendered = Mustache.render(template_html,val);
                    item_rendered.push(rendered);
                });
            } else {
                $.each( collection , function( key, val ) {
                    // if (type == "store_details"){
                    //     val.alt_store_front_url = getImageURL(val.store_front_url);    
                    // }
                    if (type == "promotions"){
                        // start = new Date (val.start_date + "T05:00:00Z");
                        // end = new Date (val.end_date + "T05:00:00Z");
                        // // start.setDate(start.getDate()+1);
                        // // end.setDate(end.getDate()+1);
                        // val.dates = (get_month(start.getMonth()))+" "+(start.getDate())+" - "+get_month(end.getMonth())+" "+end.getDate();
                        
                        var start = moment(val.start_date).tz(getPropertyTimeZone());
                        var end = moment(val.end_date).tz(getPropertyTimeZone());
                        if (start.format("DMY") == end.format("DMY")){
                        	val.dates = start.format("MMM D");
                        }
                        else {
                        	val.dates = start.format("MMM D") + " - " + end.format("MMM D");
                        }
                        if (val.description.length > 110) {
                           val.description =  val.description.substring(0,100)+'...';
                        } 
                        if ((val.promo_image_url).indexOf('missing.png') > -1){
                            var pathArray = window.location.pathname.split( '/' );
                            var slug = pathArray[pathArray.length-1];
                            var store_details = getStoreDetailsBySlug(slug);
                            val.alt_promo_image_url = getImageURL(store_details.store_front_url);
                        } else {
                            val.alt_promo_image_url = getImageURL(val.promo_image_url);
                        }
                        $("#promo_header").show();   
                        $("#mobile_promo_header").show();  
                    }
                    if (type == "jobs") {
                        var pathArray = window.location.pathname.split( '/' );
                        var slug = pathArray[pathArray.length-1];
                        var store_details = getStoreDetailsBySlug(slug);
                        val.image_url = getImageURL(store_details.store_front_url);
                        $("#job_header").show();  
                        $("#mobile_job_header").show(); 
                    }
                    var rendered = Mustache.render(template_html,val);
                    item_rendered.push(rendered);
                });
            }
            $(container).show();
            $(container).html(item_rendered.join(''));
            if (type == "store_details"){
                if (collection.website != "" && collection.website != undefined){
                        $("#store_website_link").show();
                }
            }
            
        }
        
        function convert_hour(d){
            var h = addZero(d.getUTCHours());
            var m = addZero(d.getUTCMinutes());
            var s = addZero(d.getUTCSeconds());
            if (h >= 12) {
                if ( h != 12) {
                    h = h - 12;    
                }
                
                i = "PM"
            } else {
                if (h == 0) { h = 12 }
                i = "AM"
            }
            return h+":"+m+" "+i;
        }
        
        
        
        function addZero(i) {
            if (i < 10) {
                i = "0" + i;
            }
            return i;
        }
        


        
        
    });
    
    var isMobile = ( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) );
    $("#pop-over").hide();
    var didPanZoom = false;
    var pathArray = window.location.pathname.split( '/' );
    var slug = pathArray[pathArray.length-1];
    var store_details = getStoreDetailsBySlug(slug);
    // renderSVGMap(store_details);
    
    
    function renderSVGMap(store_details){
            if(navigator.appVersion.indexOf("MSIE 9.") == -1){
                $('#map').bind('mousemove', function(e){
                    //console.log(e.pageX+","+e.pageY);
                   $('#pop-over').css({'top':e.pageY+20,'left':e.pageX-70});
                });
                // var s = Snap("#map");
                // var store_svg_id = null;
                // if(store_details.svgmap_region != null && typeof(store_details.svgmap_region)  != 'undefined'){
                //     store_svg_id = "#"+ store_details.svgmap_region;
                // }
                // var stores = getStoresList();
                // Snap.load(getSVGMapURL(), function (f) {
                //     if(store_svg_id!=null){
                //         f.select(store_svg_id).addClass("map-mouse-over");
                //         console.log(store_svg_id)
                        
                //     }
                //     $.each( stores, function( key, value ) {
                //         if(value.svgmap_region != null && typeof(value.svgmap_region)  != 'undefined'){
                //             var svg_id = "#" + value.svgmap_region;
                //             f.select(svg_id).mouseover(function() {
                //                 if(typeof(value) != 'undefined' && value != null){
                //                     this.addClass("map-mouse-over");
                //                     $("#pop-over").show();
                //                     $("#pop-over-map-name").html(value.name);
                //                     $("#pop-over-map-phone").html(value.phone);
                //                     // console.log(this.getBBox());
                //                 }
                                          
                //             });
                                
                //             //add the mouse up handler for hiding the pop over when done hovering
                            
                //                 f.select(svg_id).mouseout(function() {
                //                     if (svg_id != store_svg_id) {
                //                         this.removeClass("map-mouse-over");    
                //                     }
                                    
                //                     $("#pop-over").hide(0);
                                    
                //                 });
                                    
                            
                            
                //             //add the mouse up function for when the user clicks a store
                //             f.select(svg_id).mouseup(function() {
                                
                //                 if(!isMobile && !didPanZoom){
                                    
                //                     goToStore(value);
                //                 }
                //                 didPanZoom = false;
                                      
                //             });
                //         }
                //     });
                //     s.append(f.select("svg"));
                    
                    
                    
                // });
                
                var startingMapTransform = 'scale(0.65)';
                var startingPanX = -200;
                var startingPanY = -100;
                if(isMobile) {
                        startingMapTransform = 'scale(0.20)';
                        startingPanX = -170;
                        startingPanY = -200;
                }
                $('#loading').hide();
                $( "#page_content" ).fadeIn( "fast", function() {
                    var panzoom = $(".panzoom-elements").panzoom({
                        cursor: "move",
                        increment: 0.15,
                        minScale: 0.15,
                        maxScale: 20,
                        transition: true,
                        duration: 150,
                        easing: "ease-in-out",
                        $zoomIn: $('.zoom-in'),
                        $zoomOut: $('.zoom-out'),
                        $zoomRange: $('.zoom-range'),
                        startTransform: startingMapTransform
            
                    });
                    $(".panzoom-elements").panzoom("pan", startingPanX, startingPanY, { relative: true });
                    
                    panzoom.on('panzoomchange', function(e, panzoom, matrix, changed) {
                      didPanZoom = true;
                    });
                    
                    panzoom.on('panzoomend', function(e, panzoom, matrix, changed) {
                      didPanZoom = false;
                    });
                });
            }else{
                $('#loading').hide();
                $('#zControls').hide();
                $('#map').hide();
                $( "#page_content" ).fadeIn( "fast");
            }
        }
    function goToStore(store_details){
        if(typeof(store_details) != 'undefined' && store_details != null){
            window.location.href = "/stores/"+store_details.slug;
        }
    }
</script>
